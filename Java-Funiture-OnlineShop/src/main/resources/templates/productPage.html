<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>상품 상세 페이지</title>
    <script src="https://code.jquery.com/jquery-3.6.3.min.js" integrity="sha256-pvPw+upLPUjgMXY0G+8O0xUf+/Im1MZjXxxgOcBQBXU=" crossorigin="anonymous"></script>
</head>
<body>
<div th:if="${product != null}">
    <!-- 상품 정보 섹션 -->
    <div>
        <h1 th:text="${product.productName}">상품명</h1>
        <p th:text="${product.description}">상품 설명</p>
        <p>가격: <span id="basePrice" th:text="${product.price}">상품 가격</span>원</p>
        <p>배송비: <span id="deliveryFee" th:text="${product.deliveryFee}">배송비</span>원</p>

        <div>
            <h3>상품 이미지</h3>
            <!-- Thymeleaf를 사용하여 이미지 URL 구성 -->
            <div th:each="file, iterStat : ${product.files}">
                <div th:if="${file != null}">
                    <img id="'productImage' + ${iterStat.index}" th:src="${file.filePath}" alt="Product image">
                </div>
            </div>
        </div>
        <!-- 옵션 선택 섹션 -->
        <div th:if="${product.optionList != null}">
            <h3>옵션 선택</h3>
            <select id="optionSelect" name="optionSelect" onchange="updateTotalPrice()">
                <option selected value="">옵션 선택</option> <!-- 기본 옵션 추가 -->
                <option th:each="option : ${product.optionList}"
                        th:value="${option.id}"
                        th:text="${option.optionName}"
                        th:data-price="${option.price}"
                        th:data-stock="${option.stockQuantity}"
                        th:data-product-id="${option.productId}"> <!-- productId 데이터 속성 추가 -->
                    옵션 명
                </option>
            </select>
        </div>
        <!-- 수량 선택 섹션 -->
        <div>
            <h3>수량 선택</h3>
            <input type="number" id="quantitySelect" name="quantitySelect" min="1" max="" value="1" onchange="updateTotalPrice()">
        </div>
        <div id="totalPriceSection">
            <h3>총 가격: <span id="totalPrice"></span>원</h3>
        </div>
        <div>
            <button type="submit" id="addCartButton" onclick="addCart()">장바구니 추가</button>
        </div>
    </div>
</div>
<script th:inline="javascript">
// 총 가격 업데이트 함수 (옵션, 수량, 그리고 배송비 선택에 따라 총 가격을 계산)
function updateTotalPrice() {
    var optionSelect = document.getElementById('optionSelect');
    var selectedOption = optionSelect.options[optionSelect.selectedIndex];
    var optionPrice = selectedOption.getAttribute('data-price');
    var basePrice = document.getElementById('basePrice').textContent; // 상품 기본 가격을 HTML에서 가져옵니다.
    var deliveryFee = document.getElementById('deliveryFee').textContent; // 배송비를 HTML에서 가져옵니다.
    var quantity = document.getElementById('quantitySelect').value; // 선택된 수량을 가져옵니다.

    var totalPrice = (parseInt(basePrice, 10) + parseInt(optionPrice || 0, 10)) * parseInt(quantity, 10) + parseInt(deliveryFee, 10);
    document.getElementById('totalPrice').innerText = totalPrice; // '원' 텍스트는 HTML에 있으므로 여기에는 추가하지 않음

    var optionStock = selectedOption.getAttribute('data-stock'); // 옵션의 재고 수량을 가져옵니다.
    let maxValue = Math.min(99, optionStock); // 재고 수량과 99 중 작은 값 선택
    var inputElement = document.getElementById("quantitySelect");
    inputElement.setAttribute("max", maxValue.toString()); // 수량 선택의 최댓값을 설정합니다.
}


// 문서 로드 후 총 가격을 초기화
document.addEventListener('DOMContentLoaded', function() {
    updateTotalPrice();
});
// 장바구니 추가 함수
async function addCart() {
    const optionSelect = document.getElementById('optionSelect');
    const optionId = (optionSelect.options[optionSelect.selectedIndex]).value; // 선택된 옵션의 ID를 가져옵니다.
    const quantity = document.getElementById('quantitySelect').value; // 선택된 수량을 가져옵니다.
    const reqData = [{
        optionId: optionId,
        quantity: quantity // 선택된 수량을 서버에 전달합니다.
    }];
    // 서버에 장바구니 추가 요청을 보냅니다.
    try {
        const token = getCookie("token");
        const response = await fetch('/cart/add', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': "Bearer " + token
            },
            body: JSON.stringify(reqData)
        });
        const result = await response.json();
        if (result.success) {
            console.log(result);
            alert('장바구니에 상품이 추가되었습니다.'); // 성공 메시지를 보여줍니다.
        } else {
            console.log(result);
            alert('장바구니 추가에 실패했습니다. 다시 시도해주세요.'); // 실패 메시지를 보여줍니다.
        }
    } catch (error) {
        console.error('Error:', error);
    }
}
function getCookie(name) {
    const cookieName = name + "=";
    const cookies = document.cookie.split(';');
    for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.indexOf(cookieName) === 0) {
            return cookie.substring(cookieName.length, cookie.length);
        }
    }
    return null;
}
</script>

</body>
</html>
