<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>상품 상세 페이지</title>
</head>
<body>
<div th:if="${product != null}">
    <!-- 상품 정보 섹션 -->
    <div>
        <img th:src="@{${product.image}}" alt="상품 이미지">
    </div>
    <div>
        <h2 th:text="${product.productName}">상품 이름</h2>
        <h3 id="averageRating">평균 별점</h3>
        <p th:text="${product.price}">상품 가격</p>
        <p th:if="${product.onSale != null && product.onSale > 0}" th:text="${product.onSale}" style="display: none;">세일 가격</p>
        <p th:text="${product.description}">상품 설명</p>

        <!-- 옵션 선택 섹션 -->
        <div>
            <label for="optionSelect">옵션 선택</label>
            <select id="optionSelect">
                <option value="">-- 옵션을 선택하세요 --</option>
                <option th:each="option : ${product.options}" th:value="${option.id}" th:text="${option.optionName + ' (' + option.stockQuantity + '개)'}"
                        th:if="${option.stockQuantity > 0}"></option>
                <option value="" th:if="${option.stockQuantity <= 0}">Sold Out</option>
            </select>
        </div>

        <button onclick="addToCart()">장바구니에 추가</button>

        <script>
            function addToCart() {
                var optionId = document.getElementById('optionSelect').value;

                if (optionSelect.selectedIndex === optionSelect.options.length - 1) {
                       alert('이 옵션은 품절되었습니다.');
                       return;
                }
                if (!optionId) {
                    alert('옵션을 선택해주세요.');
                    return;
                }

                var quantity = 1;  // 수량은 1로 고정

                var data = {
                    optionId: optionId,
                    quantity: quantity
                };

                fetch('/cart/add', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('장바구니에 상품을 추가했습니다.');
                    } else {
                        alert('장바구니에 상품을 추가하는데 실패했습니다.');
                    }
                });
            }
        </script>
    </div>

    <!-- 리뷰 및 평점 섹션 -->
    <div>
        <h3>상품 리뷰</h3>
        <div th:each="comment : ${comments}">
            <p th:text="${comment.user.name} + ' : ' + ${comment.content}"></p>
            <p th:text="'별점 : ' + ${comment.rating}"></p>
        </div>
    </div>
</div>

<div th:if="${product == null}">
    <p>상품 정보를 찾을 수 없습니다.</p>
</div>

<script>
    window.onload = function() {
        let comments = /*[[${comments}]]*/ [];  // 백엔드로부터 받은 리뷰 데이터
        let sum = 0;

        for (let i = 0; i < comments.length; i++) {
            sum += comments[i].rating;  // 각 리뷰의 별점을 합산
        }

        let averageRating = (sum / comments.length).toFixed(1);  // 별점 평균 계산

        if (isNaN(averageRating)) {  // 별점 평균이 숫자가 아닌 경우
            averageRating = '0.0';
        }

        document.getElementById('averageRating').innerText = averageRating;
    }
</script>
</body>
</html>
