<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>상품 수정</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
</head>
<body>
<!-- ---------조회 섹션-------- -->
<form id="loadProduct" method="get" action="/products/{categoryId}">
    <h3>수정할 상품 선택</h3>
    <label for="selectedCategoryProduct1">대분류 카테고리 선택:</label>
    <select id="selectedCategoryProduct1" name="selectedProduct" onchange="loadProductsByCategory()">
        <option value="0">없음</option>
        <option th:each="category : ${categories}" th:value="${category.id}" th:text="${category.categoryName}"></option>
    </select><br>

    <!-- 카테고리 목록 콤보 박스 -->
    <label for="selectedCategoryProduct2">중분류 카테고리 선택:</label>
    <select id="selectedCategoryProduct2" name="selectedProduct" onchange="callSons('selectedCategoryProduct2','selectedCategoryProduct3')" required>
        <option value="0">없음</option>
    </select><br>

    <!-- 카테고리 목록 콤보 박스 -->
    <label for="selectedCategoryProduct3">소분류 카테고리 선택:</label>
    <select id="selectedCategoryProduct3" name="selectedProduct" onchange="setOutValue()" required>
        <option value="0">없음</option>
    </select><br>

    <input type="hidden" id="productCategoryId" name="productCategoryId" required>

    <!-- 상품 선택 부분 -->
    <div th:if="${product != null}">
        <h3>상품 선택</h3>
        <select id="productSelect" name="productSelect" onchange="loadProductDetails()">
            <option selected value="">상품 선택</option> <!-- 기본 옵션 추가 -->
            <option th:each="product : ${products}" th:value="${product.id}" th:text="${product.name + ' - ' + product.description}"
                    th:data-price="${product.price}" th:data-delivery-fee="${product.deliveryFee}"></option>
        </select>
    </div>
</form>

<!-- ---------수정 섹션-------- -->
<form id="updateProductForm" method="put" action="/product/{id}">
    <h2>상품 정보 수정</h2>

    <!-- 상품명 -->
    <label for="updateProductName">상품명:</label><br>
    <input type="text" id="updateProductName" name="name" th:value="*{name}" required><br>

    <!-- 상품 설명 -->
    <label for="updateProductDescription">상품 설명:</label><br>
    <textarea id="updateProductDescription" name="description" th:text="*{description}" required></textarea><br>

    <!-- 상품 가격 -->
    <label for="updateProductPrice">상품 가격:</label><br>
    <input type="number" id="updateProductPrice" name="price" th:value="*{price}" required><br>

    <!-- 배송비 -->
    <label for="updateDeliveryFee">배송비:</label><br>
    <input type="number" id="updateDeliveryFee" name="deliveryFee" th:value="*{deliveryFee}" required><br>

    <!-- 이미지 첨부 -->
    <label for="updateProductImages">상품 이미지:</label><br>
    <input type="file" id="updateProductImages" name="images" multiple><br>

    <!-- 버튼들 -->
    <button type="button" onclick="resetProductForm()">추가 생성</button>
    <button type="submit" onclick="sendProduct()">상품 저장</button>
</form>

<!-- 상품 옵션 수정 부분 -->
<form id="updateProductOptionsForm" method="post" action="/products/{productId}/save">
    <h2>상품 옵션 수정</h2>

    <!-- 상품 옵션 선택 -->
    <label for="productOptions">상품 옵션:</label><br>
    <select id="productOptions" name="productOptions">
        <option value="">선택하세요</option>
        <!-- 서버 사이드에서 제공하는 옵션 목록을 반복해서 옵션으로 표시 -->
        <option th:each="option : ${productOptions}" th:value="${option.id}" th:text="${option.name}"></option>
    </select><br>

    <!-- 옵션명 -->
    <label for="optionName">옵션명:</label><br>
    <input type="text" id="optionName" name="optionName" th:value="*{name}" required><br>

    <!-- 옵션 추가 가격 -->
    <label for="optionPrice">옵션 추가 가격:</label><br>
    <input type="number" id="optionPrice" name="optionPrice" th:value="*{additionalPrice}" required><br>

    <!-- 재고 수량 -->
    <label for="stockQuantity">재고 수량:</label><br>
    <input type="number" id="stockQuantity" name="stockQuantity" th:value="*{stockQuantity}" required><br>

    <!-- 이미지 추가 -->
    <label for="newImage">이미지 추가:</label><br>
    <input type="file" id="newImage" name="newImage"><br>

    <!-- 이미지 삭제 -->
    <label for="deleteImageId">삭제할 이미지 ID:</label><br>
    <input type="text" id="deleteImageId" name="deleteImageId"><br>

    <!-- 옵션 추가 -->
    <label for="newOptionName">추가할 옵션명:</label><br>
    <input type="text" id="newOptionName" name="newOptionName"><br>

    <!-- 옵션 삭제 -->
    <label for="deleteOptionId">삭제할 옵션 ID:</label><br>
    <input type="text" id="deleteOptionId" name="deleteOptionId"><br>

    <!-- 옵션 수정 버튼 -->
    <button type="submit">옵션 수정</button>
</form>

<script>
// 쿠키
    function getCookie(name) {
    var cookieName = name + "=";
    var cookies = document.cookie.split(';');
    for (var i = 0; i < cookies.length; i++) {
        var cookie = cookies[i].trim();
        if (cookie.indexOf(cookieName) === 0) {
            return cookie.substring(cookieName.length, cookie.length);
        }
    }
    return null;
}

// 상품을 선택했을 때 해당 상품의 정보를 수정 섹션에 자동으로 입력하는 함수
async function loadProductDetails() {
    // 선택된 상품 ID 가져오기
    var selectedProductId = $("#productSelect").val();
    const token = getCookie("token"); // 인증 토큰 가져오기

    try {
        const response = await fetch('/product/' + selectedProductId, {
            method: 'GET',
            headers: {
                'Authorization': 'Bearer ' + token
            }
        });

        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }

        const productDetails = await response.json();

        // 상품 정보를 수정 섹션의 입력 필드에 채우기
        $('#updateProductName').val(productDetails.productName);
        $('#updateProductDescription').val(productDetails.description);
        $('#updateProductPrice').val(productDetails.price);
        $('#updateDeliveryFee').val(productDetails.deliveryFee);
        // 상품의 현재 카테고리도 선택되어야 함
        $('#selectedCategoryProduct1').val(productDetails.categoryId);
        // 이미지 요청 및 표시
        const imgResponse = await fetch('/product/' + selectedProductId + '/image', {
            method: 'GET',
            headers: {
                'Authorization': 'Bearer ' + token
            }
        });

        if (!imgResponse.ok) {
            throw new Error(`HTTP error! status: ${imgResponse.status}`);
        }

        const imageBlob = await imgResponse.blob();
        const imageUrl = URL.createObjectURL(imageBlob);

        // 이미지 표시를 위한 img 태그 찾기 또는 생성
        let imgElement = $('#productImage');
        if (imgElement.length === 0) {
            imgElement = $('<img id="productImage" style="max-width: 100%; height: auto;">');
            $('#updateProductForm').append(imgElement);
        }
        imgElement.attr('src', imageUrl);
    } catch (imgError) {
            console.error('Error loading image:', imgError);
            // 이미지 불러오기 실패 시, 사용자에게 유의미한 메시지 제공
            alert(`이미지를 불러오는데 실패하였습니다: ${imgError.message}`);
        }
    catch (error) {
        console.error('Error:', error);
        alert("상품 상세 정보를 불러오는데 실패하였습니다.");
    }
}

// 상품 옵션 정보를 불러오는 함수
async function loadProductOptions() {
    var selectedProductId = $("#productSelect").val();
    const token = getCookie("token"); // 인증 토큰 가져오기

    try {
        const response = await fetch('/product/' + selectedProductId + '/options', {
            method: 'GET',
            headers: {
                'Authorization': 'Bearer ' + token
            }
        });

        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }

        const options = await response.json();
        $('#productOptions').empty().append('<option value="">선택하세요</option>');
        options.forEach((option) => {
            $('#productOptions').append(
                $('<option>').val(option.id).text(option.name)
            );
        });
    } catch (error) {
        console.error('Error:', error);
        alert("상품 옵션 정보를 불러오는데 실패하였습니다.");
    }
}

// 상품 선택 시 이벤트 핸들러
$('#productSelect').change(async function() {
    await loadProductDetails(); // 상품 상세 정보 불러오기
    await loadProductOptions(); // 상품 옵션 정보 불러오기
});

//-------------------상품 수정 카테고리-----------------//

// 상품 정보 수정
async function updateProductInfo(newName, newDescription, newPrice) {
    const selectedProductId = $("#productSelect").val();
    const token = getCookie("token");

    try {
        const response = await fetch('/product/' + selectedProductId, {
            method: 'PUT',
            headers: {
                'Authorization': 'Bearer ' + token,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                name: newName,
                description: newDescription,
                price: newPrice
            })
        });

        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }

        alert("상품 정보가 성공적으로 수정되었습니다.");
    } catch (error) {
        console.error('Error:', error);
        alert("상품 정보 수정에 실패하였습니다.");
    }
}


// 새로운 이미지 추가
async function addImage() {
    const selectedProductId = $("#productSelect").val();
    const token = getCookie("token");
    const fileInput = document.getElementById("newImage");
    const formData = new FormData();
    formData.append('image', fileInput.files[0]);

    try {
        const response = await fetch('/product/' + selectedProductId + '/image', {
            method: 'POST',
            headers: {
                'Authorization': 'Bearer ' + token
            },
            body: formData
        });

        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }

        alert("이미지가 성공적으로 추가되었습니다.");
    } catch (error) {
        console.error('Error:', error);
        alert("이미지 추가에 실패하였습니다.");
    }
}

// 이미지 삭제
async function deleteImage(imageId) {
    const selectedProductId = $("#productSelect").val();
    const token = getCookie("token");

    try {
        const response = await fetch('/product/' + selectedProductId + '/image/' + imageId, {
            method: 'DELETE',
            headers: {
                'Authorization': 'Bearer ' + token
            }
        });

        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }

        alert("이미지가 성공적으로 삭제되었습니다.");
    } catch (error) {
        console.error('Error:', error);
        alert("이미지 삭제에 실패하였습니다.");
    }
}

// 옵션 추가
async function addOption(optionName) {
    const selectedProductId = $("#productSelect").val();
    const token = getCookie("token");

    try {
        const response = await fetch('/product/' + selectedProductId + '/option', {
            method: 'POST',
            headers: {
                'Authorization': 'Bearer ' + token,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ name: optionName })
        });

        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }

        alert("옵션이 성공적으로 추가되었습니다.");
    } catch (error) {
        console.error('Error:', error);
        alert("옵션 추가에 실패하였습니다.");
    }
}

// 옵션 삭제
async function deleteOption(optionId) {
    const selectedProductId = $("#productSelect").val();
    const token = getCookie("token");

    try {
        const response = await fetch('/product/' + selectedProductId + '/option/' + optionId, {
            method: 'DELETE',
            headers: {
                'Authorization': 'Bearer ' + token
            }
        });

        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }

        alert("옵션이 성공적으로 삭제되었습니다.");
    } catch (error) {
        console.error('Error:', error);
        alert("옵션 삭제에 실패하였습니다.");
    }
}

</script>
</body>
</html>
